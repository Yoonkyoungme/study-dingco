<aside>
💡 **[ 이번 장에서 살펴볼 내용 ]**
- 코드를 타임라인 다이어그램으로 그리는 방법을 배웁니다.
- 버그를 찾기 위해 타임라인 다이어그램 보는 법을 이해합니다.
- 타임라인끼리 공유하는 자원을 줄여 코드 설계를 개선하는 방법을 알아봅니다.
</aside>

# 📘 타임라인 다이어그램

- 시간에 따른 `액션 순서` 를 시각적으로 표시한 것
- 타임라인 : 액션을 순서대로 나열한 것
- 액션의 종류
1. 순서대로 실행되는 액션
    - 두 액션이 순서대로 나타나면 같은 타임라인에 넣음
2. 동시에 나란히 실행되는 액션
    - 두 액션이 동시에 실행되거나 순서를 예상할 수 없다면 분리된 타임라인에 넣음.
    - ex) 액션 2개가 서로 다른 비동기 콜백에서 실행

### 🚨 주의할 점

1. `++` 와 `+=`  는 사실 세 단계

```tsx
total++;

var temp = total; // 읽기(액션)
temp = temp + 1; // 더하기(계산)
total = temp; // 쓰기(액션)
```

- total이 전역변수라면 읽기, 쓰기는 액션

1. 인자는 함수를 부르기 전에 실행

- 인자도 다이어그램을 그릴 때 순서대로 표현해야함

# 📘 타임라인 그리기

1. 액션 확인하기
2. 순서대로 실행되거나 동시에 실행되는 액션 그리기
3. 플랫폼에 특화된 지식을 사용해 다이어그램을 단순화하기

## ✅ 1. 액션 확인하기

- 액션 13개 (비동기 콜백 2개 포함)

```tsx
function add_item_to_cart(name, price, quantity) {
	**cart** = add_item(**cart**, name, price, quantity);
	calc_cart_total();
}

function calc_cart_total() {
	**total** = 0;
	**cost_ajax**(**cart**, function(cost) {
		**total +=** cost;
		**shipping_ajax**(**cart**, function(shipping) {
			**total +=** shipping;
			**update_total_dom**(**total**);
		});
	});
}
```

1. cart 읽기
2. cart 쓰기
3. total = 0 쓰기
4. cost_ajax() 비동기 호출
5. cart 읽기
6. total 읽기
7. total 쓰기
8. shipping_ajax() 비동기 호출
9. cart 읽기
10. total 읽기
11. total 쓰기
12. total 읽기
13. update_total_dom() 호출하기

- 콜백은 비동기로 실행되기 때문에 순서대로 실행되지 않으므로 **비동기 호출은 새로운 타임라인으로 그림**
- ajax 함수 뒤에 실행된다는 사실을 `점선` 으로 표시

## ✅ 2. 모든 액션을 다이어그램에 그리기

- ajax 콜백 두 개는 새로운 타임라인으로 그려야함
- 두 액션 사이에 시간이 얼마나 걸릴지 알 수 없으므로 다른 타임라인의 액션과 순서가 섞일 수 있음
- 하나의 박스로 묶으면 `액션이 차례로 실행되고 그 사이에 다른 작업이 끼어들 수 없음` 을 의미

```
1. cart 읽기
2. cart 쓰기
3. total = 0 쓰기
4. cost_ajax() 비동기 호출
```
```
1. cart 읽기
2. total 읽기
3. total 쓰기
4. shipping_ajax() 비동기 호출
```
```
1. cart 읽기
2. total 읽기
3. total 쓰기
4. total 읽기
5. update_total_dom() 호출
```
- 동시에 실행되는 코드는 실행 순서를 확신할 수 없음 (정확히 동시에 실행된다는 의미 ❌)

### 🚨 좋은 타임라인의 원칙

1. 타임라인은 **적을수록**, **짧을수록** 좋음
2. **공유하는 자원이 적을수록** 좋음
3. 자원을 공유한다면 안전하게 공유할 수 있도록 주의해야함
4. 재사용 가능한 객체를 통해 타이밍 문제를 쉽게 만들 수 있음

## ✅ 3. 타임라인 단순화하기

1. 하나의 타임라인에 있는 모든 액션을 하나로 통합
2. 타임라인이 끝나는 곳에서 새로운 타임라인이 하나 생긴다면 통합

- 점선이 있다면 타임라인 끝으로 옮김
- 액션이 섞일 일이 없으면 같은 박스에 넣을 수 있음
- 타임라인에 있는 단계들은 `이벤트 큐가 순서대로 처리하는 것을 보장`
- 빠르게 2번 클릭하면 클릭 핸들러가 어디에 나타나는지에 따라 액션의 순서가 달라짐

# 📘 공유하는 자원 줄이기

- 공유하는 자원 때문에 코드와 타임라인을 이해하기 어려움

## ✅ 1. 전역변수를 지역변수로 바꾸기

- total 전역 변수는 공유할 필요 없음 
- → 지역 변수로 수정 → total을 읽고 쓰는 동작이 함수 외부에 영향을 주지 않으므로 액션 ❌

## ✅ 2. 전역변수를 인자로 바꾸기

- 암묵적 인자 확인하기 → cart
- 암묵적 입력을 인자로 바꾸기 → `function calc_cart_total(cart)`
- 두 번째 타임라인은 첫 번째 타임라인의 첫 번째 단계가 끝나야 실행 (점선이 있기 때문)
-  → cart를 사용하는 첫 번째 단계는 **어느 타임라인에서나 항상 순서대로 실행**
