<aside>
💡 **[ 이번 장에서 살펴볼 내용 ]**

- 자원을 공유해서 생기는 버그를 찾는 방법을 배웁니다.
- 안전하게 자원을 공유할 수 있는 자원 공유 기본형을 만드는 방법을 이해합니다.
</aside>

- 자원을 공유한다면 서로 조율해야함
    - 올바른 결과가 나오지 않는 순서를 없애면 분석하기 쉬움

- 장바구니에 제품을 추가할 때 2번 연속으로 클릭하면 DOM 업데이트 순서에 따라 버그 발생
    - 버그는 **DOM 자원을 공유하기 때문**에 생김
    - 자원을 공유한다면 **실행 순서** 중요

# DOM 업데이트 순서 보장

- 타임라인으로 두 타임라인의 순서를 보장할 방법 없음 → **업데이트 순서를 제한**해야함
- 항상 클릭한 순서대로 DOM이 업데이트 되어야함
    - 줄을 서는 것 → **큐(queue) 자료구조** 사용
    - 여러 타임라인에 있는 액션 순서를 조율하기 위해 많이 사용
- 공유 자원이지만 안전하게 공유됨
    - 큐에 있는 모든 작업은 **같은 타임라인에서 처리되기 때문에 순서가 관리**됨

# 동시성 기본형(concurrency primitive)

- 큐를 타임라인 조율에 사용한다면 **동시성 기본형**이라고 부름
    - 자원을 안전하게 공유할 수 있는 재사용 가능한 코드
1. 큐에서 처리할 일
2. 클릭 핸들러에서 처리할 일

가능한 많은 작업을 클릭 핸들러에서 하는 것이 좋음 → 순서가 섞일 걱정 ❌

### 큐에서 처리할 작업을 큐에 넣기

큐에서 처리할 작업을 **큐에 넣는 액션 하나**로 바꾸는 작업

```tsx
// 기존 코드
calc_cart_total(cart, update_total_dom)

// 수정 코드
update_total_queue(cart);
```

- setTimeout()은 자바스크립트 이벤트 루프에 작업 추가
- 큐에 항목을 추가하고 worker 실행

## 이미 실행되는 작업이 있는지 확인해서 두 타임라인이 섞이지 않도록 만들기

- 동시에 발생하는 DOM 업데이트 순서가 섞일 수 있음
- 현재 동작하고 있는 다른 작업이 있는지 확인하여 동시에 2개가 동작하는 것을 막을 수 있음
- 쓰로틀링처럼 실행되고 있는 요청이 있다면 delay 사이의 발생하는 요청은 무시

### 함수형 프로그래밍을 하는 데 변경 가능한 값을 자주 사용하는 것 아닌가요?

- 함수형 프로그램이은 특정한 코딩 습관을 강요하는 대신 여러분의 선택을 통해 생각할 수 있는 틀 제공
- update_total_queue()는 액션이며, 호출하는 순서와 횟수가 중요한 공유자원
- 액션을 잘 사용하기 위해 값을 변경해야 한다면 그렇게 하는 것이 좋음

### 콜백 안에서 runNext()를 호출하는 이유?

- calc_cart_total()이 비동기 호출이기 때문에 콜백 안에서 runNext() 호출
- 그 안에서 두 비동기 호출에 대한 응답이 이벤트 큐에 추가되고 나중에 이벤트 루프에서 처리

# Queue 만들기

- 큐를 재사용할 수 있도록 만들기 → 비동기 요청이 끝났을 때 실행할 `done 함수` 인자로 받기
- Queue는 일반적인 함수이기 때문에 item.data와 val라는 일반적인 이름 사용
- calc_cart_work 에서는 어떤 값을 사용할지 알기 때문에 같은 값의 변수에 cart와 total이라는 이름 사용

- 장바구니 전역 변수에 접근하는 것 문제 ❌
- DOM을 공유하는 것 문제 ❌
- 큐를 공유하는 것 문제 발생 🚨 → **모든 타임라인의 서로 다른 단계에서 공유**

## 큐를 건너뛰도록 만들기

- 모든 것을 동기적으로 실행한다면 매우 느림
    - 다이어그램을 통해 큐에 있는 마지막 업데이트만 필요하다는 것을 알 수 있음
    - 새로운 작업이 들어오면 건너뛸 수 있도록 구현 → `dropping Queue`
